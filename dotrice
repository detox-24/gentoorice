#!/bin/sh

# Colors
CRE=$(tput setaf 1)    # Red
CYE=$(tput setaf 3)    # Yellow
CGR=$(tput setaf 2)    # Green
CBL=$(tput setaf 4)    # Blue
BLD=$(tput bold)       # Bold
CNC=$(tput sgr0)       # Reset colors

logo() {
    printf "\n%b%s%b\n\n" "${BLD}${CGR}" "$1" "${CNC}"
}

initial_checks() {
    # Check if running as root
    if [ "$(id -u)" = 0 ]; then
        printf "${BLD}${CRE}This script MUST NOT be run as root user.${CNC}\n"
        printf "${BLD}${CYE}Run it as your normal user. sudo will be used when needed.${CNC}\n"
        exit 1
    fi

    # Check if in HOME directory
    if [ "$PWD" != "$HOME" ]; then
        printf "${BLD}${CRE}This script must be executed from your HOME directory.${CNC}\n"
        printf "${BLD}${CYE}Current directory: ${PWD}${CNC}\n"
        printf "${BLD}${CYE}HOME directory: ${HOME}${CNC}\n"
        printf "\n${BLD}${CGR}Run: cd && ./gh0stzk-dotfiles-gentoo.sh${CNC}\n"
        exit 1
    fi
}

welcome() {
    clear
    logo "Welcome $USER - Gentoo Edition"

    printf "%b" "${BLD}${CGR}This script will install gh0stzk's dotfiles on Gentoo and this is what it will do:${CNC}

  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Setup GURU overlay for additional packages
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Check necessary dependencies and install them
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Download dotfiles in ${HOME}/.local/share/gh0stzk
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Backup of possible existing configurations (bspwm, polybar, etc...)
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Install dotfiles configuration
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Enabling MPD service (Music player daemon)
  ${BLD}${CGR}[${CYE}i${CGR}]${CNC} Change your shell to zsh shell

${BLD}${CGR}[${CRE}!${CGR}]${CNC} ${BLD}${CRE}My dotfiles DO NOT modify any of your system configurations${CNC}
${BLD}${CGR}[${CRE}!${CGR}]${CNC} ${BLD}${CRE}This script does NOT have the potential power to break your system${CNC}

${BLD}${CYE}Note: Some packages may need to be compiled from source on Gentoo.
This may take a while depending on your system.${CNC}

"

    while :; do
        printf " %b" "${BLD}${CGR}Do you wish to continue?${CNC} [y/N]: "
        read -r yn
        case "$yn" in
            [Yy])
                break ;;
            [Nn]|"")
                printf "\n%b\n" "${BLD}${CYE}Operation cancelled${CNC}"
                exit 0 ;;
            *)
                printf "\n%b\n" "${BLD}${CRE}Error:${CNC} Just write '${BLD}${CYE}y${CNC}' or '${BLD}${CYE}n${CNC}'" ;;
        esac
    done
}

setup_guru_overlay() {
    clear
    logo "Setting up GURU overlay"
    sleep 2

    printf "%b\n" "${BLD}${CYE}GURU is a community overlay with additional packages...${CNC}"

    if [ ! -d /var/db/repos/guru ]; then
        printf "%b\n" "${BLD}${CYE}Adding GURU overlay...${CNC}"
        sudo emerge --ask=n app-eselect/eselect-repository
        sudo eselect repository enable guru
        sudo emaint sync -r guru
        printf "\n%b\n" "${BLD}${CGR}GURU overlay added successfully!${CNC}"
    else
        printf "%b\n" "${BLD}${CYE}GURU overlay already exists${CNC}"
    fi
    sleep 3
}

install_dependencies() {
    clear
    logo "Installing needed packages from Gentoo repositories..."
    sleep 2

    printf "%b\n" "${BLD}${CYE}Syncing portage tree...${CNC}"
    sudo emerge --sync

    # Gentoo package equivalents
    dependencies="x11-terms/alacritty sys-apps/bat x11-wm/bspwm x11-misc/dunst sys-apps/eza media-gfx/feh app-shells/fzf x11-misc/xfce4-thunar www-client/firefox app-editors/geany dev-vcs/git media-gfx/imagemagick app-misc/jq x11-terms/kitty media-libs/libwebp media-gfx/maim media-sound/mpc media-sound/mpd media-video/mpv app-editors/neovim media-sound/ncmpcpp net-libs/nodejs media-sound/pulseaudio-ctl x11-themes/papirus-icon-theme x11-misc/picom media-sound/playerctl x11-misc/polybar x11-misc/redshift x11-misc/rofi x11-misc/sxhkd x11-misc/xclip x11-misc/xdg-user-dirs x11-misc/xdotool x11-apps/xsetroot app-misc/yazi app-shells/zsh app-shells/zsh-completions"

    to_install=""
    already_installed=""
    failed_deps=""
    retry_failed=""

    # Check which packages are already installed
    printf "\n%b\n" "${BLD}${CYE}Checking installed packages...${CNC}"
    for pkg in $dependencies; do
        if qlist -I "$pkg" >/dev/null 2>&1 || equery list "$pkg" >/dev/null 2>&1; then
            already_installed="$already_installed $pkg"
            printf "%b\n" "${BLD}${CGR}[✓]${CNC} ${pkg} ${BLD}${CGR}already installed${CNC}"
        else
            to_install="$to_install $pkg"
            printf "%b\n" "${BLD}${CYE}[ ]${CNC} ${pkg} ${BLD}${CYE}needs installation${CNC}"
        fi
    done

    if [ -z "$to_install" ]; then
        printf "\n%b\n" "${BLD}${CGR}All dependencies are already installed!${CNC}"
        sleep 3
        return
    fi

    printf "\n%b\n" "${BLD}${CYE}Installing missing packages...${CNC}"
    
    # First pass - only install what's missing
    for pkg in $to_install; do
        printf "%b\n" "${BLD}${CYE}Installing ${CBL}${pkg}${CNC}"
        if ! sudo emerge --ask=n --quiet-build=y "$pkg"; then
            failed_deps="$failed_deps $pkg"
        fi
    done

    # Retry failures
    if [ -n "$failed_deps" ]; then
        printf "\n%b\n" "${BLD}${CRE}These dependencies failed:${CYE}${failed_deps}${CNC}"
        printf "%b\n\n" "${BLD}${CYE}Retrying installation...${CNC}"

        for pkg in $failed_deps; do
            if ! sudo emerge --ask=n "$pkg"; then
                retry_failed="$retry_failed $pkg"
            fi
        done
    fi

    # Final Result
    if [ -n "$retry_failed" ]; then
        printf "\n%b\n" "${BLD}${CRE}These dependencies could not be installed:${CYE}${retry_failed}${CNC}"
        printf "%b\n\n" "${BLD}${CBL}missing_apps.txt ${CYE}file was created in your ${CGR}HOME${CNC}"
        printf "The following dependencies failed, please install manually:\n%s\n" "$retry_failed" > missing_apps.txt
    else
        printf "\n%b\n" "${BLD}${CGR}All dependencies were installed successfully.${CNC}"
    fi
    sleep 3
}

install_fonts() {
    clear
    logo "Installing fonts..."
    sleep 2

    fonts="media-fonts/inconsolata media-fonts/jetbrains-mono media-fonts/terminus-font media-fonts/nerd-fonts"

    to_install=""
    
    # Check which fonts are already installed
    for font in $fonts; do
        if qlist -I "$font" >/dev/null 2>&1 || equery list "$font" >/dev/null 2>&1; then
            printf "%b\n" "${BLD}${CGR}[✓]${CNC} ${font} ${BLD}${CGR}already installed${CNC}"
        else
            to_install="$to_install $font"
            printf "%b\n" "${BLD}${CYE}[ ]${CNC} ${font} ${BLD}${CYE}needs installation${CNC}"
        fi
    done

    if [ -z "$to_install" ]; then
        printf "\n%b\n" "${BLD}${CGR}All fonts are already installed!${CNC}"
        sleep 2
        return
    fi

    printf "\n%b\n" "${BLD}${CYE}Installing missing fonts...${CNC}"
    for font in $to_install; do
        printf "%b\n" "${BLD}${CYE}Installing ${CBL}${font}${CNC}"
        sudo emerge --ask=n --quiet-build=y "$font" || true
    done

    printf "\n%b\n" "${BLD}${CGR}Fonts installation complete!${CNC}"
    sleep 2
}

install_additional_packages() {
    clear
    logo "Installing additional packages (may need compilation)..."
    sleep 2

    # These might need manual installation or overlays
    additional="media-sound/mpd media-plugins/mpd-discord-rpc"

    to_install=""
    
    # Check which packages are already installed
    for pkg in $additional; do
        if qlist -I "$pkg" >/dev/null 2>&1 || equery list "$pkg" >/dev/null 2>&1; then
            printf "%b\n" "${BLD}${CGR}[✓]${CNC} ${pkg} ${BLD}${CGR}already installed${CNC}"
        else
            to_install="$to_install $pkg"
            printf "%b\n" "${BLD}${CYE}[ ]${CNC} ${pkg} ${BLD}${CYE}needs installation${CNC}"
        fi
    done

    if [ -z "$to_install" ]; then
        printf "\n%b\n" "${BLD}${CGR}All additional packages are already installed!${CNC}"
        sleep 2
        return
    fi

    printf "\n%b\n" "${BLD}${CYE}Installing additional packages...${CNC}"
    printf "%b\n" "${BLD}${CYE}Note: Some of these may take a while to compile${CNC}"

    for pkg in $to_install; do
        sudo emerge --ask=n --quiet-build=y "$pkg" 2>/dev/null || \
            printf "%b\n" "${BLD}${CRE}Could not install ${pkg} - may need manual installation${CNC}"
    done

    sleep 2
}

install_eww() {
    clear
    logo "Installing eww (Elkowar's Wacky Widgets)..."
    sleep 2

    # Check if eww exists in repos
    if sudo emerge --search eww | grep -q "x11-misc/eww"; then
        printf "%b\n" "${BLD}${CYE}Installing eww from repository...${CNC}"
        sudo emerge --ask=n x11-misc/eww
    else
        printf "%b\n" "${BLD}${CYE}eww not found in repos, will need to be installed manually${CNC}"
        printf "%b\n" "${BLD}${CYE}Visit: https://github.com/elkowar/eww${CNC}"
        echo "eww - https://github.com/elkowar/eww" >> missing_apps.txt
    fi
    sleep 2
}

clone_dotfiles() {
    clear
    logo "Downloading dotfiles"
    repo_url="https://github.com/gh0stzk/dotfiles"
    repo_dir="$HOME/.local/share/gh0stzk"
    timestamp=$(date +"%Y%m%d-%H%M%S")
    sleep 2

    # Handle existing repository
    if [ -d "$repo_dir" ]; then
        backup_dir="${repo_dir}_$timestamp"
        printf "%b\n" "${BLD}${CYE}Existing repository found - renaming to: ${CBL}${backup_dir}${CNC}"
        mv -v "$repo_dir" "$backup_dir"
    fi

    # Clone new repository
    printf "%b\n" "${BLD}${CYE}Cloning dotfiles from: ${CBL}${repo_url}${CNC}"
    git clone --depth=1 "$repo_url" "$repo_dir"
    sleep 3
}

backup_existing_config() {
    clear
    logo "Backup files"
    sleep 2

    printf "%b" "My dotfiles come with a lightweight, simple, and functional Neovim configuration.\nBut if you already have a custom, super pro Neovim configuration and don't want to try mine, just type 'n'\n\n"

    while :; do
        printf "%b" "${BLD}${CYE}Do you want to use gh0stzk's Neovim setup? ${CNC}[y/N]: "
        read -r try_nvim
        case "$try_nvim" in
            [Yy]) try_nvim="y"; break ;;
            [Nn]|"") try_nvim="n"; break ;;
            *) printf " %b%bError:%b write 'y' or 'n'\n" "${BLD}" "${CRE}" "${CNC}" ;;
        esac
    done

    backup_folder="$HOME/.RiceBackup/$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$backup_folder"
    printf "\n%b\n\n" "${BLD}${CYE}Backup directory: ${CBL}$backup_folder${CNC}"
    sleep 1

    # Dirs in ~/.config/
    cfg_dir="bspwm alacritty clipcat picom rofi eww sxhkd dunst kitty polybar geany gtk-3.0 ncmpcpp yazi zsh mpd"
    for cfg in $cfg_dir; do
        [ -d "$HOME/.config/$cfg" ] && mv "$HOME/.config/$cfg" "$backup_folder"
    done

    # Individual files/dirs in Home
    for f in ".icons" ".zshrc" ".gtkrc-2.0"; do
        [ -e "$HOME/$f" ] && mv "$HOME/$f" "$backup_folder"
    done

    # If user wants to try the nvim config
    if [ "$try_nvim" = "y" ]; then
        [ -d "$HOME/.config/nvim" ] && mv "$HOME/.config/nvim" "$backup_folder"
    fi

    printf "\n%b\n\n" "${BLD}${CGR}All files moved to:${CNC} ${BLD}${CYE}$backup_folder${CNC}"
    sleep 3
}

install_dotfiles() {
    clear
    logo "Installing dotfiles..."
    printf "%s%s Copying files to respective directories...%s\n\n" "$BLD" "$CBL" "$CNC"
    sleep 2

    # Create required directories if not exists
    for dir in "$HOME/.config" "$HOME/.local/bin" "$HOME/.local/share"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir" && \
            printf "%s%sCreated directory: %s%s%s\n" "$BLD" "$CGR" "$CBL" "$dir" "$CNC"
        fi
    done

    # Copy files to ~/.config
    dots_config_dir="alacritty bspwm clipcat geany gtk-3.0 kitty mpd ncmpcpp yazi zsh"
    for dots_cfg in $dots_config_dir; do
        if [ -d "$HOME/.local/share/gh0stzk/config/$dots_cfg" ]; then
            cp -R "$HOME/.local/share/gh0stzk/config/$dots_cfg" "$HOME/.config/"
        fi
    done

    # If user wants to try the nvim config
    [ "$try_nvim" = "y" ] && [ -d "$HOME/.local/share/gh0stzk/config/nvim" ] && \
        cp -R "$HOME/.local/share/gh0stzk/config/nvim" "$HOME/.config/"

    # Copy files to ~/.local/share
    dots_misc_dir="applications asciiart fonts"
    for dots_misc in $dots_misc_dir; do
        if [ -d "$HOME/.local/share/gh0stzk/misc/$dots_misc" ]; then
            cp -R "$HOME/.local/share/gh0stzk/misc/$dots_misc" "$HOME/.local/share/"
        fi
    done

    # Copy bin dir to ~/.local
    if [ -d "$HOME/.local/share/gh0stzk/misc/bin" ]; then
        cp -R "$HOME/.local/share/gh0stzk/misc/bin" "$HOME/.local/"
    fi

    # Copy remaining files
    dots_home_dir=".icons .zshrc .gtkrc-2.0"
    for dots_home in $dots_home_dir; do
        if [ -e "$HOME/.local/share/gh0stzk/home/$dots_home" ]; then
            cp -R "$HOME/.local/share/gh0stzk/home/$dots_home" "$HOME/"
        fi
    done

    # Update font cache
    fc-cache -r

    # Generate xdg dirs
    if [ ! -e "$HOME/.config/user-dirs.dirs" ]; then
        xdg-user-dirs-update
    fi

    printf "\n%s%sDotfiles installed successfully!%s\n" "$BLD" "$CGR" "$CNC"
    sleep 3
}

configure_services() {
    clear
    logo "Configuring Services"
    picom_config="$HOME/.config/bspwm/config/picom.conf"
    sleep 2

    # Check if OpenRC or systemd
    if command -v systemctl >/dev/null 2>&1; then
        # systemd
        printf "%b\n" "${BLD}${CYE}Detected systemd...${CNC}"
        
        # MPD Service Management
        if systemctl is-enabled --quiet mpd.service 2>/dev/null; then
            printf "%b\n" "${BLD}${CYE}Disabling global MPD service...${CNC}"
            sudo systemctl disable --now mpd.service
        fi

        # User-level MPD Service
        printf "%b\n" "${BLD}${CYE}Enabling user MPD service...${CNC}"
        systemctl --user enable --now mpd.service
    else
        # OpenRC
        printf "%b\n" "${BLD}${CYE}Detected OpenRC...${CNC}"
        printf "%b\n" "${BLD}${CYE}MPD will need to be started manually or added to default runlevel${CNC}"
        printf "%b\n" "${BLD}${CYE}Run: rc-update add mpd default${CNC}"
    fi

    # Virtual Machine Detection
    is_virtual_machine() {
        if command -v systemd-detect-virt >/dev/null 2>&1; then
            systemd-detect-virt --quiet >/dev/null 2>&1
        else
            # Fallback detection
            grep -q "hypervisor" /proc/cpuinfo 2>/dev/null
        fi
    }

    # Picom Configuration for VMs
    if is_virtual_machine; then
        printf "%b\n" "${BLD}${CYE}Virtual machine detected${CNC}"
        printf "\n%b\n" "${BLD}${CYE}Adjusting Picom configuration...${CNC}"

        if [ -f "$picom_config" ]; then
            if sed -i 's/backend = "glx"/backend = "xrender"/' "$picom_config"; then
                printf "%b\n" "${BLD}${CGR}Picom backend changed to xrender${CNC}"
            fi
            if sed -i 's/vsync = true/vsync = false/' "$picom_config"; then
                printf "%b\n\n" "${BLD}${CGR}Picom vSync disabled${CNC}"
            fi
        else
            printf "%b\n\n" "${BLD}${CRE}Picom config file missing: ${CYE}${picom_config}${CNC}"
        fi
    fi
    sleep 3
}

change_default_shell() {
    clear
    logo "Changing default shell to zsh"
    zsh_path=$(command -v zsh)
    sleep 2

    if [ -z "$zsh_path" ]; then
        printf "%b\n\n" "${BLD}${CRE}Zsh is not installed! Cannot change shell${CNC}"
        return
    fi

    if [ "$SHELL" != "$zsh_path" ]; then
        printf "%b\n" "${BLD}${CYE}Changing your shell to Zsh...${CNC}"

        if chsh -s "$zsh_path"; then
            printf "%b\n" "\n${BLD}${CGR}Shell changed successfully!${CNC}"
        else
            printf "%b\n\n" "\n${BLD}${CRE}Error changing shell!${CNC}"
        fi
    else
        printf "%b\n\n" "${BLD}${CGR}Zsh is already your default shell!${CNC}"
    fi
    sleep 3
}

final_prompt() {
    clear
    logo "Installation Complete"

    printf "%b\n" "${BLD}${CGR}Installation completed successfully!${CNC}"
    
    if [ -f "$HOME/missing_apps.txt" ]; then
        printf "%b\n" "${BLD}${CYE}Some packages couldn't be installed automatically.${CNC}"
        printf "%b\n" "${BLD}${CYE}Check ${CBL}~/missing_apps.txt${CYE} for the list.${CNC}"
    fi

    printf "\n%b\n" "${BLD}${CYE}Next steps:${CNC}"
    printf "%b\n" "  ${BLD}1.${CNC} Log out and log back in (or reboot)"
    printf "%b\n" "  ${BLD}2.${CNC} Select bspwm as your window manager"
    printf "%b\n" "  ${BLD}3.${CNC} Enjoy your new rice!"
    printf "\n%b\n\n" "${BLD}${CRE}Note: You may need to install a display manager (like lightdm or sddm) if you don't have one${CNC}"

    while :; do
        printf "%b" "${BLD}${CYE}Reboot now?${CNC} [y/N]: "
        read -r yn
        case "$yn" in
            [Yy]) printf "\n%b\n" "${BLD}${CGR}Initiating reboot...${CNC}"
                sleep 1
                sudo reboot
                break ;;
            [Nn]|"") printf "\n%b\n\n" "${BLD}${CYE}Remember to log out and back in!${CNC}"
                    break ;;
            *) printf " %b%bError:%b write 'y' or 'n'\n" "${BLD}" "${CRE}" "${CNC}" ;;
        esac
    done
}

# --- Main run --- #
initial_checks
welcome
setup_guru_overlay
install_dependencies
install_fonts
install_additional_packages
install_eww
clone_dotfiles
backup_existing_config
install_dotfiles
configure_services
change_default_shell
final_prompt
